{% extends 'base.html' %}
{% load piece_extra %}
{% load staticfiles %}
{% block content %}

<h1 class="text-center">{{ piece.book_position }}. {{ piece.title }}</h1>




<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
        <div id="infos_piece_text">
            <p><b>Composer</b> : {{ piece.composer }}</p>
            <p><b>Main Source</b> : {{ piece.mainsource }}</p>
            <p><b>Variants Sources</b> : {% for source in othersources %}<ul><li>{{ source }}</li></ul>{% endfor %}</p>
            <p><b>Lyricist-Poet</b> : {{ piece.poet_lyricist }}</p>
            <p><b>Voice number</b> : {{ piece.voices_number }}</p>
            <p><b>Voice name</b> : {{ piece.voices_name }}</p>
            <!--<p><b>Style musical</b> : {{ piece.genre_musical_normalise }}</p>
            <p><b>Genre musical</b> : {{ piece.genre_musical_detaille }}</p>-->
            <p><b>Remarks</b> : {{ piece.remarks }}</p>
        </div>
    </div>
    <div class="col-xs-12 col-sm-9 col-md-6 col-lg-6">
        <div class="litteray-text">
            <h3>Lyrics :</h3>
            <!--<p>{{ piece.lyrics.text }}</p>-->
        </div>
    </div>
    <div class="col-xs-5 col-sm-3 col-md-2 col-lg-2">
        <div id="link" class="text-center">
            <a href=""><img src="{{ STATIC_URL}}/img/pdf.png" height="40px"></a>
            <a href="{{piece.mei_link}}"><img src="{{ STATIC_URL}}/img/mei.png" height="40px"></a>
            <!--{% if user.is_authenticated %}
            <a href=""><img src="{{ STATIC_URL}}/img/itunes.png" height="40px"></a>
            {% endif %}-->
        </div>
    </div>
    




    
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="viewer" style="margin-top:0;margin-left:0;margin-right:0;margin-bottom:20px;"></div>

    </div>
    
    


    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-3">

    <div id="piece_comment">
        <button id="buttonCom" class="btn btn-default" onclick="triggerComment()" value="Send a message">Send a message</button>
        <form id="addCom" method="POST" enctype="multipart/form-data" action="{% url 'messageprocessing:addComment' %}">{% csrf_token %}
            {% if piece.voices_name %}
            <select id="comment_voice" name="voice" style="width: 49%;" required>
                <option value="">Voice</option>
                {% for voice in piece.split_voices %}
                <option value="{{voice}}">{{voice}}</option>
                {% endfor %}
            </select>
            {% endif %}
            <input id="comment_measure" name="measure" type="number" maxlength="3" pattern="(\d)(\d)(\d)" placeholder="Measure" style="width: 49%;" required/><br/>
            <textarea id="comment_text" name="message" cols="30" rows="5" style="resize: none; width: 100%;" placeholder="Message"></textarea>
            {%  if not request.user.is_authenticated %}
                <input type="mail" name="mail" placeholder="E-mail address" required style="width: 100%;"/><br/>
            {% else %}
                <input type="hidden" name="mail" value=""/>
            {% endif %}
            <label for="file">Join a file : </label><input type="file" id="file" name="file"/>
            <input type="hidden" name="piece" value="{{ piece.id }}"/>
            <input type="submit" value="Send"/>
        </form>
        <div id="piece_comments_zone">
        {% for com in comments %}
            <div id="comment{{ com.id }}" class="piece_comment_text {% if not com.validate %}comment_invalidate{% endif %}">
                <table>
                    <thead>
                        <th>
                            {% if com.posteur %}
                                {{ com.posteur.person.nickname }}
                            {% else %}
                                Visitor
                            {% endif %}
                             <span class="date_message">({{ com.timestamp|date:"M d, Y" }})</span>
                        </th>
                        {% if perms.gesualdo.validate_message %}
                            {% if not com.validated %}
                                <form class="validateCom" method="POST" action="{% url 'messageproce:validateComment'%}">{% csrf_token %}
                                    <input type="hidden" name="id" value="{{ com.id }}"/>
                                    <input id="valide{{ com.id }}" type="image" src="{% static 'imagesCss/valider.gif' %}" class="commit_message_button" title="Validate" alt="V" value="submit"/>
                                </form>
                            {% endif %}
                                <form class="archiveCom" method="POST" action="{% url 'messageprocessing:archiveComment' %}">{% csrf_token %}
                                    <input type="hidden" name="id" value="{{ com.id }}"/>
                                    <input id="arch{{ com.id }}" type="image" src="{% static 'imagesCss/archive.png' %}" class="commit_message_button" title="Archive" alt="A" valute="submit"/>
                                </form>
                                
                                <form class="deletCom" method="POST" action="{% url 'messageprocessing:refuseComment' %}">{% csrf_token %}
                                    <input type="hidden" name="id" value="{{ com.id }}"/>
                                    <input id="suppr{{ com.id }}" type="image" src="{% static 'imagesCss/refuser.png' %}" class="commit_message_button" title="Delete" alt="X" value="submit"/>
                                </form>
                        {% endif %}
                    </thead>
                    <tr>
                        <td {% if perms.gesualdo.validate_message %}colspan="2"{% endif %}>{{ com.message }}</td>
                    </tr>
                </table>
            </div>
        {% endfor %}
        
        </div>
    </div>
    </div>
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 critical-apparatus">
        <div class="row">
            <h3>Critical Apparatus</h3>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 critical-apparatus-section">
                <div class="critical-apparatus-section_content">
                    <h4>General :</h4>
                    <!-- <p>{{ piece.critical_apparatus_general }}</p> -->
                </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 critical-apparatus-section">
                <div class="critical-apparatus-section_content">
                    <h4>Text :</h4>
                    <!-- <p>{{ piece.critical_apparatus_text }}</p> -->
                </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 critical-apparatus-section">
                <div class="critical-apparatus-section_content">
                    <h4>Music :</h4>
                    <!-- <p>{{ piece.critical_apparatus_music }}</p> -->
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{% static 'scripts.js' %}"></script>

    <!-- Comment script -->
    <script type="text/javascript" src="{{ STATIC_URL }}/js/comment.js"></script> 


     <!-- meiView dependencies and scripts -->

  <script type="text/JavaScript" src="/static/js/vexflow/vexflow-min.js"></script>
  <script type="text/JavaScript" src="/static/js/deps/Fabric-all.js"></script>
  <script type="text/JavaScript" src="/static/js/deps/meitovexflow.min.js"></script>

  <script type="text/JavaScript" src="/static/js/dist/meiview.js"></script>
  <link rel="stylesheet" href="/static/css/dist/meiview.css"/>

  <script type="application/javascript" language="javascript">
    $(document).ready( function(){

      /* Load an MEI file from an XML document */
      var loadedXML = meiView.Util.loadXMLDoc('{{ STATIC_URL}}testmei.mei');

      /* Make sure the file will be suitable for rendering */
      var filteredXml = meiView.filterMei(loadedXML, { noSysBreak:true });

      /* Make sure the MEI will be suitable for rendering */
      var meiDoc = new MeiLib.MeiDoc(filteredXml);

      var pagination = new meiView.Pages({
        length: $(meiDoc.rich_score).find('measure').length,
        mpp: 4,
      });

      /* Create a compact viewer. */
      var viewer = new meiView.CompactViewer({
        maindiv: $('.viewer'),
        MEI: meiDoc,
        pages: pagination,
        title: "{{ piece.title }}",
        displayFirstPage: true,
        scale: 0.8,
        pxpMeasure: 280,
      });

    })
  </script>
{% endblock %}
